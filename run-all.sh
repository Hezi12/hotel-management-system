#!/bin/bash

# מציג הודעת פתיחה
echo "מפעיל את מערכת ניהול המלון..."
echo "==============================================="

# בדיקה אם יש תהליכים תקועים
echo "בודק אם יש תהליכים תקועים..."
PORT_5001=$(lsof -ti:5001)
PORT_3000=$(lsof -ti:3000)

# במידה ונמצאו תהליכים תקועים, הפעל את סקריפט הניקוי
if [ ! -z "$PORT_5001" ] || [ ! -z "$PORT_3000" ]; then
  echo "נמצאו תהליכים תקועים על פורטים. מנקה אותם..."
  bash cleanup.sh
fi

# הפעלת השרת
echo "הפעלת השרת..."
cd server && npm run dev & 
SERVER_PID=$!

# חזרה לתיקייה הראשית והפעלת הקליינט
echo "הפעלת הקליינט..."
cd "$(dirname "$0")" # חזרה לתיקייה הראשית של הפרויקט
cd client && npm run dev &
CLIENT_PID=$!

# פונקציה שתרוץ בעת סגירת הסקריפט
function cleanup {
  echo "סוגר את כל התהליכים..."
  kill $SERVER_PID
  kill $CLIENT_PID
  exit
}

# רשום את הפונקציה לסגירה בעת קבלת אות סיום
trap cleanup SIGINT

# שמירת מזהי התהליכים לקובץ למקרה שנצטרך לסגור אותם מאוחר יותר
echo "$CLIENT_PID $SERVER_PID" > .run_pids

# מציג הודעה על איך לסגור
echo "המערכת פועלת!"
echo "ממשק המשתמש זמין בכתובת: http://localhost:3000 (יתכן שיהיה זמין בפורט 3001 או 3002)"
echo "ממשק הניהול זמין בכתובת: http://localhost:3000/admin (יתכן שיהיה זמין בפורט 3001 או 3002)"
echo "ה-API של השרת זמין בכתובת: http://localhost:5001/api"
echo "לחץ על CTRL+C כדי לעצור את כל השירותים"

# השאר את הסקריפט רץ
wait 